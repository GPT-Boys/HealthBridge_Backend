â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     HEALTHBRIDGE BILLING SERVICE
                        GUÃA PARA INTEGRACIÃ“N FRONTEND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ ÃNDICE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. INFORMACIÃ“N GENERAL
2. AUTENTICACIÃ“N, CORS Y RATE LIMITING
3. MODELOS Y ESTADOS (RESUMEN)
4. ENDPOINTS - FACTURAS (Invoices)
5. ENDPOINTS - PAGOS (Payments)
6. ENDPOINTS - REPORTES (Reports)
7. WEBHOOKS (Stripe)
8. EJEMPLOS CON AXIOS + Stripe.js
9. MANEJO DE ERRORES (Patrones)
10. NOTAS Y BUENAS PRÃCTICAS


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. INFORMACIÃ“N GENERAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”— URLs BASE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Gateway (recomendado): http://localhost:3000/api/billing
â€¢ Servicio directo (dev): http://localhost:3006

ğŸ—„ï¸ BASE DE DATOS Y COLECCIONES:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ MongoDB: healthbridge_billing
â€¢ Colecciones: invoices, payments, transactions

ğŸ”Œ Servicios relacionados:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ User Service (datos de usuario/paciente/doctor)
â€¢ Appointment Service (generar factura desde cita completada)
â€¢ Notification Service (envÃ­o de factura por email)
â€¢ Stripe (procesamiento de pagos con tarjeta)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
2. AUTENTICACIÃ“N, CORS Y RATE LIMITING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”’ AutenticaciÃ³n (JWT):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Header: Authorization: Bearer <access_token>
â€¢ Payload esperado: { userId, email, role: 'admin' | 'doctor' | 'patient' }
â€¢ Roles por recurso:
  - Facturas: ver (admin/doctor/patient limitado a lo propio), crear/emitir/editar (admin/doctor)
  - Pagos: crear manual (admin/doctor), pagar con Stripe (admin/doctor/patient), reembolsos (admin)
  - Reportes: financieros (admin), por doctor (admin/doctor), por paciente (admin/doctor/patient)

ğŸŒ CORS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ OrÃ­genes permitidos (por defecto): http://localhost:5173, http://localhost:3000, http://localhost:8080
â€¢ Headers: Content-Type, Authorization

â±ï¸ Rate limiting:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ 100 solicitudes cada 15 minutos por IP (vÃ­a gateway/servicio)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
3. MODELOS Y ESTADOS (RESUMEN)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ§¾ Invoice (Factura):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Campos clave: invoiceNumber, patientId, doctorId, items[{ description, quantity, unitPrice }],
  subtotal, discountPercentage, insuranceInfo?, totalAmount, amountPaid, amountDue,
  status, issueDate, dueDate
â€¢ Estados: draft | issued | paid | partially_paid | overdue | cancelled | refunded
â€¢ Reglas:
  - Calculo de totales automÃ¡tico (pre-save)
  - Solo se puede actualizar en draft
  - issue -> emite factura; cancel -> no permitido si paid/refunded

ğŸ’° Payment (Pago):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Campos clave: invoiceId, amount, currency, paymentMethod(stripe|cash|bank_transfer|qr),
  status, paymentDetails (Stripe IDs, etc.), refunds[]
â€¢ Estados: pending | processing | completed | failed | refunded | partially_refunded
â€¢ Reglas:
  - Reembolsos: parciales o totales, cambian refundedAmount y status

ğŸ“’ Transaction (TransacciÃ³n - auditorÃ­a):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Tipos: payment | refund | adjustment | fee | discount
â€¢ PropÃ³sito: trazabilidad financiera (monto, referencia, quiÃ©n creÃ³)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
4. ENDPOINTS - FACTURAS (Invoices)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Base: /api/billing/invoices (Gateway)  |  /api/invoices (Servicio directo)

â”€ Crear factura
POST /api/billing/invoices
Roles: admin, doctor
Headers: Authorization: Bearer <token>
Body JSON:
{
  "patientId": "<mongoId>",
  "doctorId": "<mongoId>",          // opcional
  "facilityId": "<mongoId>",        // opcional
  "items": [
    { "description": "Consulta", "quantity": 1, "unitPrice": 120 }
  ],
  "discountPercentage": 0,           // opcional [0-100]
  "hasInsurance": false,
  "insuranceInfo": {                 // opcional
    "provider": "SeguroX",
    "policyNumber": "ABC-123",
    "coveragePercentage": 70
  },
  "notes": "..."                    // opcional
}
200/201 Response:
{ success: true, message, data: { ...invoice } }

â”€ Crear factura desde cita
POST /api/billing/invoices/appointment/:appointmentId
Roles: admin, doctor
Headers: Authorization: Bearer <token>
Params: appointmentId (mongoId) â€“ la cita debe estar status=completed
201 Response: { success: true, data: { ...invoice } }

â”€ Listar facturas (filtros y paginaciÃ³n)
GET /api/billing/invoices?patientId=&doctorId=&status=&dateFrom=&dateTo=&page=1&limit=10
Roles: cualquier autenticado
200 Response:
{ success: true, data: [ ...invoices ], pagination: { total, page, totalPages } }

â”€ Obtener factura por ID
GET /api/billing/invoices/:id
Roles: cualquier autenticado
200 Response: { success: true, data: { ...invoice } }
404: Factura no encontrada

â”€ Emitir factura (draft -> issued)
PUT /api/billing/invoices/:id/issue
Roles: admin, doctor
200 Response: { success: true, message, data: { ...invoice } }

â”€ Actualizar factura (solo draft)
PUT /api/billing/invoices/:id
Roles: admin, doctor
Body: Campos permitidos (items, discountPercentage, notes, dueDate)
200 Response: { success: true, message, data: { ...invoice } }

â”€ Cancelar factura
DELETE /api/billing/invoices/:id
Roles: admin
Body opcional: { "reason": "..." }
200 Response: { success: true, message, data: { ...invoice } }

â”€ Descargar PDF
GET /api/billing/invoices/:id/pdf
Roles: cualquier autenticado
Response: application/pdf (content-disposition: attachment)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
5. ENDPOINTS - PAGOS (Payments)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Base: /api/billing/payments (Gateway)  |  /api/payments (Servicio directo)

â”€ Crear pago MANUAL (efectivo/transferencia/QR)
POST /api/billing/payments/invoice/:invoiceId/manual
Roles: admin, doctor
Body JSON:
{
  "amount": 100,
  "paymentMethod": "cash",    // cash | bank_transfer | qr
  "paymentDetails": { ... },   // opcional
  "notes": "..."               // opcional
}
201 Response: { success: true, data: { ...payment } }
400: Monto invÃ¡lido | MÃ©todo no permitido | Excede saldo

â”€ Pagar con STRIPE (tarjeta)
POST /api/billing/payments/invoice/:invoiceId/stripe
Roles: admin, doctor, patient
Body JSON:
{
  "paymentMethodId": "pm_..."   // obtenido desde Stripe.js
}
201 Response: { success: true, data: { ...payment } }
Errores comunes: 404 (Factura no encontrada), 400 (Factura ya pagada), 402 (pago rechazado)

â”€ Reembolsar pago
POST /api/billing/payments/:paymentId/refund
Roles: admin
Body JSON:
{
  "amount": 50,                 // opcional; por defecto total disponible
  "reason": "servicio no prestado"
}
200 Response: { success: true, data: { ...refund | payment } }

â”€ Listar pagos
GET /api/billing/payments?invoiceId=&patientId=&status=&dateFrom=&dateTo=&page=&limit=
Roles: admin, doctor
200 Response: { success: true, data: [ ...payments ], pagination: { ... } }

â”€ Obtener pago por ID
GET /api/billing/payments/:id
Roles: admin, doctor, patient (acceso restringido a propios)
200 Response: { success: true, data: { ...payment } }


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
6. ENDPOINTS - REPORTES (Reports)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Base: /api/billing/reports (Gateway)  |  /api/reports (Servicio directo)

â”€ Reporte financiero general
GET /api/billing/reports/financial?dateFrom=YYYY-MM-DD&dateTo=YYYY-MM-DD&doctorId=&facilityId=&groupBy=day|week|month
Roles: admin
200 Response: {
  success: true,
  data: {
    totalFacturado, totalPagado, totalPendiente, cantidadFacturas
  }
}

â”€ Ingresos por doctor
GET /api/billing/reports/doctor/:doctorId?dateFrom=&dateTo=
Roles: admin, doctor

â”€ Historial por paciente
GET /api/billing/reports/patient/:patientId?dateFrom=&dateTo=
Roles: admin, doctor, patient (acceso restringido)

â”€ Cuentas por cobrar (pendientes/vencidas)
GET /api/billing/reports/pending
Roles: admin, doctor


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
7. WEBHOOKS (Stripe)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ Solo para Stripe. No llamar desde el frontend.

Ruta (servicio directo):
POST http://localhost:3006/webhooks/stripe

Ruta vÃ­a gateway (si es necesario):
POST http://localhost:3000/api/billing/webhooks/stripe

Headers:
â€¢ stripe-signature: <firma_proporcionada_por_stripe>
Body: application/json (raw) â€“ el servidor ya espera raw body en esta ruta

Eventos manejados:
â€¢ payment_intent.succeeded
â€¢ payment_intent.payment_failed
â€¢ charge.refunded


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
8. EJEMPLOS CON AXIOS + Stripe.js
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Setup de clientes:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// src/api/billing.ts
import axios from 'axios';

const API = 'http://localhost:3000/api/billing';

const billing = axios.create({ baseURL: API });

billing.interceptors.request.use((config) => {
  const token = localStorage.getItem('accessToken');
  if (token) config.headers.Authorization = `Bearer ${token}`;
  return config;
});

export default billing;


A) Crear factura (admin/doctor):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import billing from '@/api/billing';

export async function createInvoice(payload) {
  const { data } = await billing.post('/invoices', payload);
  return data.data; // invoice
}


B) Descargar PDF de factura:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export async function downloadInvoicePDF(id) {
  const res = await billing.get(`/invoices/${id}/pdf`, { responseType: 'blob' });
  const url = window.URL.createObjectURL(new Blob([res.data], { type: 'application/pdf' }));
  const a = document.createElement('a');
  a.href = url; a.download = `factura-${id}.pdf`; a.click();
  window.URL.revokeObjectURL(url);
}


C) Pagar con Stripe (Stripe.js + paymentMethodId):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1) En el frontend ya inicializaste Stripe.js y obtuviste paymentMethodId
// 2) Llamas al backend para procesar el pago completo del saldo de la factura
export async function payInvoiceWithStripe(invoiceId, paymentMethodId) {
  const { data } = await billing.post(`/payments/invoice/${invoiceId}/stripe`, { paymentMethodId });
  return data.data; // payment
}


D) Pago manual (efectivo/transferencia/QR):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export async function payInvoiceManual(invoiceId, payload) {
  // payload: { amount, paymentMethod: 'cash'|'bank_transfer'|'qr', paymentDetails?, notes? }
  const { data } = await billing.post(`/payments/invoice/${invoiceId}/manual`, payload);
  return data.data; // payment
}


E) Reembolso (admin):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export async function refundPayment(paymentId, { amount, reason }) {
  const { data } = await billing.post(`/payments/${paymentId}/refund`, { amount, reason });
  return data.data; // refund o payment
}


F) Listar facturas/pagos con filtros:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export async function listInvoices(params) {
  const { data } = await billing.get('/invoices', { params });
  return data; // { success, data, pagination }
}

export async function listPayments(params) {
  const { data } = await billing.get('/payments', { params });
  return data; // { success, data, pagination }
}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
9. MANEJO DE ERRORES (Patrones)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CÃ³digos frecuentes:
â€¢ 400: Datos invÃ¡lidos (validaciones express-validator)
â€¢ 401: No autenticado (Bearer faltante/expirado)
â€¢ 403: Sin permisos (rol insuficiente)
â€¢ 404: No encontrado (factura/pago)
â€¢ 409: Conflicto (ya pagado, etc.)
â€¢ 422: Entidad no procesable (webhook / stripe errors)
â€¢ 500: Error interno

Estructura comÃºn:
{ success: false, message: "DescripciÃ³n del error" }

Recomendaciones frontend:
â€¢ Interceptor global: si 401 => limpiar token y redirigir a /login
â€¢ Si 403 => mostrar aviso de permisos
â€¢ Validar inputs antes de enviar (mismas reglas que backend)
â€¢ Mostrar mensajes de Stripe al usuario si el pago falla


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
10. NOTAS Y BUENAS PRÃCTICAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â€¢ Siempre usar el Gateway en frontend: http://localhost:3000/api/billing
â€¢ Para Stripe, obtÃ©n paymentMethodId con Stripe.js (no envÃ­es datos de tarjeta al backend)
â€¢ PDF: usa responseType: 'blob' y descarga con un anchor temporal
â€¢ PaginaciÃ³n: limita a 100 por pÃ¡gina como mÃ¡ximo
â€¢ Estados de factura se derivan de pagos (amountPaid vs totalAmount)
â€¢ Para citas: usa "Crear factura desde cita" al completar una cita
â€¢ Los reportes requieren rangos de fechas vÃ¡lidos (ISO 8601)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              FIN DEL DOCUMENTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GuÃ­a completa para integrar el mÃ³dulo de FacturaciÃ³n y Pagos en el frontend.
Ante dudas, revisa README.md del billing-service y los logs en /logs.
